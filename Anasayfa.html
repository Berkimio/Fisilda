<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fısılda - Anlık Mesajlaşma</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="Css/AnaCss.css">
</head>
<body>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<!-- Header -->
<div class="header">
    <button class="menu-toggle">
        <i class="fas fa-bars"></i>
    </button>
    <div class="logo">
        <i class="fas fa-comments"></i>
        <h1>Fısılda</h1>
    </div>
    <div class="user-actions">
        <button class="icon-btn" id="theme-toggle-btn" title="Gece Modu">
            <i class="fas fa-moon"></i>
        </button>
        <button class="icon-btn" id="debug-btn" title="Hata Ayıklama">
            <i class="fas fa-bug"></i>
        </button>
        <button class="icon-btn" id="refresh-btn" title="Yenile">
            <i class="fas fa-sync-alt"></i>
        </button>
        <button class="icon-btn" id="logout-btn" title="Çıkış Yap">
            <i class="fas fa-sign-out-alt"></i>
        </button>
    </div>
</div>

<!-- Overlay -->
<div class="overlay"></div>

<!-- Main Container -->
<div class="main-container">
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="search-container">
            <div class="search-box">
                <i class="fas fa-search"></i>
                <input type="text" id="search-input" placeholder="Kişi veya mesaj ara">
            </div>
        </div>
        
        <div class="conversation-list" id="conversation-list">
            <!-- Kullanıcılar buraya eklenecek -->
        </div>
    </div>

    <!-- Chat Area -->
    <div class="chat-area">
        <div class="chat-header">
            <button class="icon-btn back-button">
                <i class="fas fa-arrow-left"></i>
            </button>
            <div class="chat-info">
                <div class="avatar-container">
                    <div class="avatar" id="current-chat-avatar"></div>
                    <div class="online-status offline" id="online-status"></div>
                </div>
                <div class="user-details">
                    <div class="user-name" id="current-chat-name">Bir sohbet seçin</div>
                    <div class="user-status">
                        <span class="status-dot offline" id="status-dot"></span>
                        <span id="current-chat-status">çevrimdışı</span>
                    </div>
                </div>
            </div>
            <div class="chat-actions">
                <button class="icon-btn" title="Sesli arama" id="voice-call-btn"><i class="fas fa-phone"></i></button>
                <button class="icon-btn" title="Görüntülü arama" id="video-call-btn"><i class="fas fa-video"></i></button>
                <button class="icon-btn" title="Kullanıcı bilgileri" id="user-info-btn"><i class="fas fa-info-circle"></i></button>
            </div>
        </div>

        <div class="messages-container" id="messages-container">
            <div class="welcome-message">
                <i class="fas fa-comments"></i>
                <h3>Fısılda'ya Hoş Geldiniz</h3>
                <p>Bir kişi seçerek sohbete başlayın</p>
            </div>
        </div>

        <div class="message-input-container">
            <button style="color:#777;" class="icon-btn" title="Dosya ekle" id="attach-file-btn"><i class="fas fa-paperclip"></i></button>
            <input type="text" class="message-input" id="message-input" placeholder="Mesaj yaz..." disabled>
            <button style="color:#777;" class="icon-btn" title="Emoji ekle" id="emoji-picker-btn"><i class="fas fa-smile"></i></button>
            <button class="send-btn" id="send-btn" title="Gönder" disabled><i class="fas fa-paper-plane"></i></button>
        </div>
    </div>
</div>

<!-- Emoji Picker --><div class="emoji-picker-container" id="emoji-picker"><div class="emoji-grid"></div></div><!-- Debug Panel --><div class="debug-panel" id="debug-panel"> <script src="a.js"></script> <h4>Hata Ayıklama Bilgileri</h4>  <div id="debug-content">Yükleniyor...</div></div>
<script>

const _0x1a2b3c = (function() {
    const _0x4d5e6f = {
        'b': function(_0x3a9b4d) {
            let _0x5c6d7e = '';
            for (let _0x8e9f0a = 0; _0x8e9f0a < _0x3a9b4d.length; _0x8e9f0a++) {
                _0x5c6d7e += String.fromCharCode(_0x3a9b4d.charCodeAt(_0x8e9f0a) ^ 0x42);
            }
            return _0x5c6d7e;
        }
    };
    return _0x4d5e6f;
})();

// firebase config
const __0x2f8e9a = {
    apiKey: "AIzaSysG7k-zFAXQ37vhKtjGRJDT5ZiGpPQhqT4",
    authDomain: "fisailda-4d414.firebaseapp.com",
    projectId: "fsi2lda-8d414",
    storageBucket: "fisssilda-4d414.firebasestorage.app",
    messagingSenderId: "857850492179",
    appId: "2:857850492179:web:0b57c6314ca58a4d9ed6e6"
};

// Global state object
const _0x7d8e9f = {
    'app': null,
    'auth': null,
    'db': null,
    'currentUser': null,
    'activeChatUID': null,
    'messagesUnsub': null,
    'userListUnsub': null,
    'lastMessagesUnsub': null
};

// Firebase başlatma
(function() {
    try {
        _0x7d8e9f.app = firebase.initializeApp(_0x2f8e9a);
        _0x7d8e9f.auth = firebase.auth();
        _0x7d8e9f.db = firebase.firestore();
        console.log("Firebase başlatıldı");
    } catch (error) {
        console.error("Firebase başlatma hatası:", error);
    }
})();

// Auth state kontrolü - karmaşıklaştırılmış
_0x7d8e9f.auth.onAuthStateChanged((_0x2c3d4e) => {
    if (_0x2c3d4e) {
        _0x7d8e9f.currentUser = _0x2c3d4e;
        
        Promise.all([
            _0x8f9a0b(true),
            _0xa1b2c3()
        ]).then(() => {
            document.getElementById('message-input').disabled = false;
            document.getElementById('send-btn').disabled = false;
        }).catch(_0xd7e8f9);
        
    } else {
        _0x7d8e9f.currentUser = null;
        window.location.href = 'Giris.html';
    }
});

// Çevrimiçi durum güncelleme
async function _0x8f9a0b(_0x3e4f5a) {
    if (!_0x7d8e9f.currentUser) return;
    
    try {
        await _0x7d8e9f.db.collection('users').doc(_0x7d8e9f.currentUser.uid).update({
            'online': _0x3e4f5a,
            'lastSeen': firebase.firestore.FieldValue.serverTimestamp()
        });
    } catch (_0xf4g5h6) {
        _0xd7e8f9(_0xf4g5h6);
    }
}

// Kullanıcı listesi yükleme
async function _0xa1b2c3() {
    try {
        if (_0x7d8e9f.userListUnsub) _0x7d8e9f.userListUnsub();
        
        const _0x9i0j1k = _0x7d8e9f.db.collection('users');
        _0x7d8e9f.userListUnsub = _0x9i0j1k.onSnapshot((_0x2k3l4m) => {
            _0x5n6o7p(_0x2k3l4m);
        }, _0xd7e8f9);
    } catch (_0xe8f9a0) {
        _0xd7e8f9(_0xe8f9a0);
    }
}

// Kullanıcı listesi render
function _0x5n6o7p(_0x3l4m5n) {
    const _0x6o7p8q = document.getElementById('conversation-list');
    _0x6o7p8q.innerHTML = '';
    
    _0x3l4m5n.forEach(_0x7p8q9r => {
        const _0x8q9r0s = _0x7p8q9r.data();
        if (_0x8q9r0s.uid === _0x7d8e9f.currentUser?.uid) return;
        
        const _0x9r0s1t = document.createElement('div');
        _0x9r0s1t.className = 'conversation-item';
        _0x9r0s1t.dataset.uid = _0x8q9r0s.uid;
        _0x9r0s1t.innerHTML = _0xb1c2d3(_0x8q9r0s);
        _0x9r0s1t.addEventListener('click', () => _0xd3e4f5(_0x8q9r0s.uid, _0x8q9r0s.fullname));
        
        _0x6o7p8q.appendChild(_0x9r0s1t);
    });
    
    _0xe4f5g6();
}

// Kullanıcı item template
function _0xb1c2d3(_0x8q9r0s) {
    return `
        <div class="avatar">${_0x8q9r0s.fullname?.charAt(0) || 'K'}</div>
        <div class="conversation-info">
            <div class="conversation-name">${_0x8q9r0s.fullname || 'Kullanıcı'}</div>
            <div class="last-message">Henüz mesaj yok</div>
        </div>
        <div class="conversation-meta">
            <div class="timestamp"></div>
            <div class="unread-count" style="display: none;">0</div>
        </div>`;
}

// Mesaj gönderme
async function _0xc4d5e6() {
    const _0x9a0b1c = document.getElementById('message-input');
    const _0xb1c2d3 = _0x9a0b1c.value.trim();
    
    if (!_0xb1c2d3 || !_0x7d8e9f.activeChatUID) return;

    try {
        await _0x7d8e9f.db.collection('messages').add({
            'sender': _0x7d8e9f.currentUser.uid,
            'receiver': _0x7d8e9f.activeChatUID,
            'text': _0xb1c2d3,
            'timestamp': firebase.firestore.FieldValue.serverTimestamp(),
            'read': false
        });
        
        _0x9a0b1c.value = '';
    } catch (_0xf4g5h6) {
        _0xd7e8f9(_0xf4g5h6);
    }
}

// Hata işleme
function _0xd7e8f9(_0xf5g6h7) {
    console.error('Hata:', _0xf5g6h7);
}

// Sohbet seçme
function _0xd3e4f5(_0xe4f5g6, _0xf5g6h7) {
    if (_0x7d8e9f.messagesUnsub) _0x7d8e9f.messagesUnsub();
    
    _0x7d8e9f.activeChatUID = _0xe4f5g6;
    
    // UI güncelleme
    document.getElementById('current-chat-name').textContent = _0xf5g6h7;
    document.getElementById('current-chat-avatar').textContent = _0xf5g6h7.charAt(0);
    
    // Mesajları dinle
    const _0x6h7i8j = _0x7d8e9f.db.collection('messages').orderBy('timestamp', 'asc');
    _0x7d8e9f.messagesUnsub = _0x6h7i8j.onSnapshot(_0x7i8j9k => {
        _0x8j9k0l(_0x7i8j9k);
    }, _0xd7e8f9);
}

// Mesajları render et
function _0x8j9k0l(_0x9k0l1m) {
    const _0x0l1m2n = document.getElementById('messages-container');
    _0x0l1m2n.innerHTML = '';
    
    const _0x1m2n3o = _0x9k0l1m.docs.filter(_0x2n3o4p => {
        const _0x3o4p5q = _0x2n3o4p.data();
        return (_0x3o4p5q.sender === _0x7d8e9f.currentUser.uid && 
                _0x3o4p5q.receiver === _0x7d8e9f.activeChatUID) ||
               (_0x3o4p5q.sender === _0x7d8e9f.activeChatUID && 
                _0x3o4p5q.receiver === _0x7d8e9f.currentUser.uid);
    });
    
    _0x1m2n3o.forEach(_0x4p5q6r => {
        _0x5q6r7s(_0x4p5q6r, _0x0l1m2n);
    });
    
    _0x0l1m2n.scrollTop = _0x0l1m2n.scrollHeight;
}

// Mesaj item oluştur
function _0x5q6r7s(_0x6r7s8t, _0x7s8t9u) {
    const _0x8t9u0v = _0x6r7s8t.data();
    const _0x9u0v1w = document.createElement('div');
    
    _0x9u0v1w.className = _0x8t9u0v.sender === _0x7d8e9f.currentUser.uid ? 
        'message-sent' : 'message-received';
    
    _0x9u0v1w.innerHTML = `
        <div class="message-content">
            <div class="message-text">${_0x8t9u0v.text || ''}</div>
            <div class="message-time">${_0xa2b3c4(new Date((_0x8t9u0v.timestamp?.seconds || 0) * 1000))}</div>
        </div>`;
    
    _0x7s8t9u.appendChild(_0x9u0v1w);
}

// Zaman formatı
function _0xa2b3c4(_0xb3c4d5) {
    const _0xc4d5e6 = new Date();
    const _0xd5e6f7 = _0xc4d5e6 - _0xb3c4d5;
    
    if (_0xd5e6f7 < 60000) return 'şimdi';
    if (_0xd5e6f7 < 3600000) return `${Math.floor(_0xd5e6f7/60000)} dk`;
    if (_0xd5e6f7 < 86400000) return _0xb3c4d5.toLocaleTimeString('tr-TR', {hour:'2-digit', minute:'2-digit'});
    return _0xb3c4d5.toLocaleDateString('tr-TR', {day:'numeric', month:'short'});
}

// Son mesajları yükle
function _0xe4f5g6() {
    if (_0x7d8e9f.lastMessagesUnsub) _0x7d8e9f.lastMessagesUnsub();
    
    const _0xf5g6h7 = _0x7d8e9f.db.collection('messages').orderBy('timestamp', 'desc');
    
    _0x7d8e9f.lastMessagesUnsub = _0xf5g6h7.onSnapshot(_0x6h7i8j => {
        _0x7i8j9k(_0x6h7i8j);
    }, _0xd7e8f9);
}

function _0x7i8j9k(_0x8j9k0l) {
    const _0x9k0l1m = {};
    
    _0x8j9k0l.forEach(_0x0l1m2n => {
        const _0x1m2n3o = _0x0l1m2n.data();
        if (_0x1m2n3o.sender === _0x7d8e9f.currentUser?.uid || 
            _0x1m2n3o.receiver === _0x7d8e9f.currentUser?.uid) {
            
            const _0x2n3o4p = _0x1m2n3o.sender === _0x7d8e9f.currentUser?.uid ? 
                _0x1m2n3o.receiver : _0x1m2n3o.sender;
            
            if (!_0x9k0l1m[_0x2n3o4p]) {
                _0x9k0l1m[_0x2n3o4p] = {
                    'text': _0x1m2n3o.text,
                    'timestamp': _0x1m2n3o.timestamp,
                    'isSender': _0x1m2n3o.sender === _0x7d8e9f.currentUser?.uid
                };
            }
        }
    });
    
    _0x3o4p5q(_0x9k0l1m);
}

function _0x3o4p5q(_0x4p5q6r) {
    document.querySelectorAll('.conversation-item').forEach(_0x5q6r7s => {
        const _0x6r7s8t = _0x5q6r7s.dataset.uid;
        const _0x7s8t9u = _0x4p5q6r[_0x6r7s8t];
        
        if (_0x7s8t9u) {
            const _0x8t9u0v = _0x5q6r7s.querySelector('.last-message');
            const _0x9u0v1w = _0x5q6r7s.querySelector('.timestamp');
            
            _0x8t9u0v.textContent = _0x7s8t9u.isSender ? 
                `Sen: ${_0x7s8t9u.text}` : _0x7s8t9u.text;
            
            if (_0x7s8t9u.timestamp?.seconds) {
                _0x9u0v1w.textContent = _0xa2b3c4(new Date(_0x7s8t9u.timestamp.seconds * 1000));
            }
        }
    });
}

// Event listener'lar
const _0xc3d4e5 = {
    'send-btn': _0xc4d5e6,
    'refresh-btn': _0xa1b2c3,
    'logout-btn': async () => {
        await _0x8f9a0b(false);
        await _0x7d8e9f.auth.signOut();
        window.location.href = 'Giris.html';
    },
    'theme-toggle-btn': function() {
        document.body.classList.toggle('night-mode');
        localStorage.setItem('nightMode', document.body.classList.contains('night-mode') ? 'enabled' : 'disabled');
    },
    'debug-btn': function() {
        const debugPanel = document.getElementById('debug-panel');
        debugPanel.style.display = debugPanel.style.display === 'block' ? 'none' : 'block';
    }
};

['send-btn', 'refresh-btn', 'logout-btn', 'theme-toggle-btn', 'emoji-picker-btn', 'debug-btn'].forEach(_0xa1b2c3 => {
    document.getElementById(_0xa1b2c3)?.addEventListener('click', _0xc3d4e5[_0xa1b2c3] || function() {});
});

// Enter tuşu ile mesaj gönderme
document.getElementById('message-input')?.addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        _0xc4d5e6();
    }
});

// DOM yüklendikten sonra
document.addEventListener('DOMContentLoaded', function() {
    // Gece modu
    if (localStorage.getItem('nightMode') === 'enabled') {
        document.body.classList.add('night-mode');
    }
    
    // Emoji picker
    const _0x4p5q6r = ['😀', '😂', '😍', '🥰', '😎', '🙄', '😮', '😢', '😡', '🤢', '❤️', '👍', '👎', '🔥', '🎉', '🤔', '👀', '🙏'];
    const _0x5q6r7s = document.querySelector('.emoji-grid');
    
    if (_0x5q6r7s) {
        _0x4p5q6r.forEach(_0x6r7s8t => {
            const _0x7s8t9u = document.createElement('div');
            _0x7s8t9u.className = 'emoji';
            _0x7s8t9u.textContent = _0x6r7s8t;
            _0x7s8t9u.addEventListener('click', () => {
                document.getElementById('message-input').value += _0x6r7s8t;
            });
            _0x5q6r7s.appendChild(_0x7s8t9u);
        });
    }

    // Responsive menü
    const _0x8t9u0v = document.querySelector('.menu-toggle');
    const _0x9u0v1w = document.querySelector('.sidebar');
    const _0xa0v1w2 = document.querySelector('.overlay');
    
    _0x8t9u0v?.addEventListener('click', () => {
        _0x9u0v1w.classList.toggle('active');
        _0xa0v1w2.classList.toggle('active');
    });
    
    _0xa0v1w2?.addEventListener('click', () => {
        _0x9u0v1w.classList.remove('active');
        _0xa0v1w2.classList.remove('active');
    });
});

// Sayfa kapatma
window.addEventListener('beforeunload', () => {
    ['messagesUnsub', 'userListUnsub', 'lastMessagesUnsub'].forEach(_0x3o4p5q => {
        if (_0x7d8e9f[_0x3o4p5q]) _0x7d8e9f[_0x3o4p5q]();
    });
    
    _0x8f9a0b(false);
});
</script>


<script src="Guard.js"></script>
</body>
</html>
